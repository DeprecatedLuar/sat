#!/usr/bin/env bash
# sat - Satellite installer (universal package manager)

SAT_LIBRARY="${XDG_DATA_HOME:-$HOME/.local/share}/sat/lib"

# Ensure library is present (fetch from GitHub if missing)
_ensure_lib() {
    [[ -f "$SAT_LIBRARY/common.sh" ]] && return 0

    echo "Downloading latest sat version..."
    mkdir -p "$SAT_LIBRARY"

    if ! curl -sSL "https://github.com/DeprecatedLuar/sat/archive/refs/heads/main.tar.gz" | \
         tar xzf - --strip-components=2 -C "$SAT_LIBRARY" "sat-main/lib" 2>/dev/null; then
        echo "Error: Failed to download sat. Check network connection and firewall settings." >&2
        exit 1
    fi
}

_ensure_lib
source "$SAT_LIBRARY/common.sh"

# ══════════════════════════════════════════════════════════════════════════════
# ──[MANIFEST FUNCTIONS]────────────────────────────────────────────────────────
# ══════════════════════════════════════════════════════════════════════════════
# Internal functions for manifest manipulation. Used by the API.

# sat-manifest (system manifest: tool=source)
_sat_manifest_add()    { sed -i "/^$1=/d" "$SAT_MANIFEST" 2>/dev/null; echo "$1=$2" >> "$SAT_MANIFEST"; }
_sat_manifest_get()    { grep "^$1=" "$SAT_MANIFEST" 2>/dev/null | cut -d= -f2; }
_sat_manifest_remove() { sed -i "/^$1=/d" "$SAT_MANIFEST"; }
_sat_manifest_has()    { grep -q "^$1=" "$SAT_MANIFEST" 2>/dev/null; }

# shell-manifest (master manifest: tool:source:pid)
_shell_manifest_add()        { echo "$1:$2:$3" >> "$SAT_SHELL_MASTER"; }
_shell_manifest_pids()       { grep "^$1:$2:" "$SAT_SHELL_MASTER" 2>/dev/null | cut -d: -f3; }
_shell_manifest_has()        { grep -q "^$1:" "$SAT_SHELL_MASTER" 2>/dev/null; }
_shell_manifest_remove()     { sed -i "\|^$1:$2:$3\$|d" "$SAT_SHELL_MASTER"; }
_shell_manifest_remove_all() { sed -i "\|^$1:|d" "$SAT_SHELL_MASTER"; }
_shell_manifest_promote() {
    local tool="$1" src="$2"
    sed -i "\|^${tool}:${src}:|d" "$SAT_SHELL_MASTER"
    _sat_manifest_has "$tool" || _sat_manifest_add "$tool" "$src"
}

# pid-manifest (session manifest: TOOL=x, SOURCE_x=y)
_pid_manifest_add() {
    local pid="$1" tool="$2" src="$3"
    mkdir -p "$SAT_SHELL_DIR/$pid"
    echo "TOOL=$tool" >> "$SAT_SHELL_DIR/$pid/manifest"
    echo "SOURCE_$tool=$src" >> "$SAT_SHELL_DIR/$pid/manifest"
}
_pid_manifest_tools()  { [[ -f "$SAT_SHELL_DIR/$1/manifest" ]] && grep "^TOOL=" "$SAT_SHELL_DIR/$1/manifest" | cut -d= -f2; }
_pid_manifest_source() { [[ -f "$SAT_SHELL_DIR/$1/manifest" ]] && grep "^SOURCE_$2=" "$SAT_SHELL_DIR/$1/manifest" | cut -d= -f2; }
_pid_manifest_remove() { rm -rf "$SAT_SHELL_DIR/$1" "/tmp/sat-$1" 2>/dev/null; }

# Skip cleanup for internal API calls (prevents recursion)
[[ "$1" != "internal" ]] && cleanup_orphaned_sessions

# ══════════════════════════════════════════════════════════════════════════════
# ──[ROUTER]────────────────────────────────────────────────────────────────────
# ══════════════════════════════════════════════════════════════════════════════

case "$1" in
    deps|dependencies)
        source "$SAT_LIBRARY/commands/deps.sh"
        sat_deps
        ;;

    install|i)
        shift
        source "$SAT_LIBRARY/commands/install.sh"
        sat_install "$@"
        ;;

    search)
        [[ -z "$2" ]] && { echo "Usage: sat search <program> [--wrap]"; exit 1; }
        shift
        source "$SAT_LIBRARY/commands/search.sh"
        sat_search "$@"
        ;;

    uninstall|remove|rm)
        [[ -z "$2" ]] && { echo "Usage: sat uninstall <program> [program2] ..."; exit 1; }
        shift
        source "$SAT_LIBRARY/commands/uninstall.sh"
        sat_uninstall "$@"
        ;;

    shell)
        shift
        source "$SAT_LIBRARY/commands/shell.sh"
        sat_shell "$@"
        ;;

    list|ls)
        source "$SAT_LIBRARY/commands/list.sh"
        sat_list
        ;;

    track)
        [[ -z "$2" ]] && { echo "Usage: sat track <program> [program2] ..."; exit 1; }
        shift
        source "$SAT_LIBRARY/commands/track.sh"
        sat_track "$@"
        ;;

    scan)
        source "$SAT_LIBRARY/commands/scan.sh"
        sat_scan
        ;;

    untrack)
        [[ -z "$2" ]] && { echo "Usage: sat untrack <program> [program2] ..."; exit 1; }
        shift
        source "$SAT_LIBRARY/commands/untrack.sh"
        sat_untrack "$@"
        ;;

    source|src)
        [[ -z "$2" ]] && { echo "Usage: sat source <packagemanager>"; exit 1; }
        SOURCE_SCRIPT="$SAT_BASE/packages/sources/$2.sh"
        source <(curl -sSL "$SOURCE_SCRIPT") || { echo "Source '$2' not found"; exit 1; }
        # Try bootstrap function, else _ensure_<name> pattern
        if declare -f bootstrap &>/dev/null; then
            bootstrap
        elif declare -f "_ensure_$2" &>/dev/null; then
            "_ensure_$2"
        fi
        ;;

    clone)
        shift
        source "$SAT_LIBRARY/commands/clone.sh"
        sat_clone "$@"
        ;;

    pull)
        source "$SAT_LIBRARY/commands/pull.sh"
        sat_pull
        ;;

    info|which|whereis)
        [[ -z "$2" ]] && { echo "Usage: sat info <program> [program2] ..."; exit 1; }
        shift
        source "$SAT_LIBRARY/commands/info.sh"
        sat_info "$@"
        ;;

    # ══════════════════════════════════════════════════════════════════════════════
    # ──[INTERNAL API]──────────────────────────────────────────────────────────────
    # ══════════════════════════════════════════════════════════════════════════════
    internal)
        case "$2" in
            sat-manifest)
                case "$3" in
                    add)
                        [[ -z "$4" || -z "$5" ]] && { echo "Usage: sat internal sat-manifest add <tool> <source>"; exit 1; }
                        _sat_manifest_add "$4" "$5"
                        ;;
                    get)
                        [[ -z "$4" ]] && { echo "Usage: sat internal sat-manifest get <tool>"; exit 1; }
                        _sat_manifest_get "$4"
                        ;;
                    remove)
                        [[ -z "$4" ]] && { echo "Usage: sat internal sat-manifest remove <tool>"; exit 1; }
                        _sat_manifest_remove "$4"
                        ;;
                    has)
                        [[ -z "$4" ]] && { echo "Usage: sat internal sat-manifest has <tool>"; exit 1; }
                        _sat_manifest_has "$4"
                        ;;
                    list)
                        [[ -f "$SAT_MANIFEST" ]] && cat "$SAT_MANIFEST"
                        ;;
                    *)
                        echo "Usage: sat internal sat-manifest <add|get|remove|has|list> [args]"; exit 1
                        ;;
                esac
                ;;
            shell-manifest)
                case "$3" in
                    add)
                        [[ -z "$4" || -z "$5" || -z "$6" ]] && { echo "Usage: sat internal shell-manifest add <tool> <source> <pid>"; exit 1; }
                        _shell_manifest_add "$4" "$5" "$6"
                        ;;
                    pids)
                        [[ -z "$4" || -z "$5" ]] && { echo "Usage: sat internal shell-manifest pids <tool> <source>"; exit 1; }
                        _shell_manifest_pids "$4" "$5"
                        ;;
                    has)
                        [[ -z "$4" ]] && { echo "Usage: sat internal shell-manifest has <tool>"; exit 1; }
                        _shell_manifest_has "$4"
                        ;;
                    remove)
                        [[ -z "$4" || -z "$5" || -z "$6" ]] && { echo "Usage: sat internal shell-manifest remove <tool> <source> <pid>"; exit 1; }
                        _shell_manifest_remove "$4" "$5" "$6"
                        ;;
                    remove-all)
                        [[ -z "$4" ]] && { echo "Usage: sat internal shell-manifest remove-all <tool>"; exit 1; }
                        _shell_manifest_remove_all "$4"
                        ;;
                    promote)
                        [[ -z "$4" || -z "$5" ]] && { echo "Usage: sat internal shell-manifest promote <tool> <source>"; exit 1; }
                        _shell_manifest_promote "$4" "$5"
                        ;;
                    list)
                        [[ -f "$SAT_SHELL_MASTER" ]] && cat "$SAT_SHELL_MASTER"
                        ;;
                    *)
                        echo "Usage: sat internal shell-manifest <add|pids|has|remove|remove-all|promote|list> [args]"; exit 1
                        ;;
                esac
                ;;
            pid-manifest)
                case "$3" in
                    add)
                        [[ -z "$4" || -z "$5" || -z "$6" ]] && { echo "Usage: sat internal pid-manifest add <pid> <tool> <source>"; exit 1; }
                        _pid_manifest_add "$4" "$5" "$6"
                        ;;
                    tools)
                        [[ -z "$4" ]] && { echo "Usage: sat internal pid-manifest tools <pid>"; exit 1; }
                        _pid_manifest_tools "$4"
                        ;;
                    source)
                        [[ -z "$4" || -z "$5" ]] && { echo "Usage: sat internal pid-manifest source <pid> <tool>"; exit 1; }
                        _pid_manifest_source "$4" "$5"
                        ;;
                    remove)
                        [[ -z "$4" ]] && { echo "Usage: sat internal pid-manifest remove <pid>"; exit 1; }
                        _pid_manifest_remove "$4"
                        ;;
                    *)
                        echo "Usage: sat internal pid-manifest <add|tools|source|remove> [args]"; exit 1
                        ;;
                esac
                ;;
            *)
                echo "Usage: sat internal <sat-manifest|shell-manifest|pid-manifest> <operation> [args]"; exit 1
                ;;
        esac
        ;;

    help|--help|-h|"")
        cat << 'EOF'
         ,-.
        / \  `.  __..-,O
       :   \ --''_..-'.'
       |    . .-' `. '.
       :     .     .`.'
        \     `.  /  ..
         \      `.   ' .
          `,       `.   \
         ,|,`.        `-.\
        '.||  ``-...__..-`
         |  |
         |__|
         /||\    Usage: sat <command>
        //||\\
       // || \\
    __//__||__\\__
   '--------------'

Commands:
  install|i <pkg>     - Install package(s) with optional source
  source|src <pm>     - Install a package manager (huber, cargo, brew, nix)
  search <program>    - Find package across sources (--all raw, --wrap full)
  uninstall|rm <prog> - Remove program installed via sat
  shell <tool>        - Temp shell with tools, auto-cleanup on exit (requires tmux)
  deps                - Install sat dependencies (tmux, wget, curl, jq)
  info <program>      - Source, path, version, shadowed installs (alias: which)
  list|ls             - List tracked packages (auto-cleans stale entries)
  track <program>     - Add existing program to manifest for sat management
  untrack <program>   - Remove from manifest without uninstalling
  scan                - Scan ecosystem dirs and add all found packages
  pull                - Refresh sat library from GitHub
  clone <repo> [dest] - Clone your repo

Source syntax (install/shell):
  pkg:sys             - System package manager (apt/pacman/etc)
  pkg:brew            - Homebrew
  pkg:nix             - Nix profile
  pkg:rs :rust        - Cargo (Rust)
  pkg:py :python      - uv (Python)
  pkg:js :node        - npm (Node)
  pkg:go              - go install

Examples:
  sat install fd:rs bat:rs ripgrep:rs
  sat shell hyperfine:brew cowsay:sys jq
EOF
        ;;

    *)
        echo "sat: unknown command '$1'" >&2
        exit 1
        ;;
esac
